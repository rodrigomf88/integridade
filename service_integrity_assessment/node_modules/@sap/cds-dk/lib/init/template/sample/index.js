const { join } = require('path')
const cds = require('../../../cds'), { exists, read, write, copy } = cds.utils
const { env4, readProject } = require('../../projectReader')
const mvn = require('../../mvn')

module.exports = class SampleTemplate extends require('../../plugin') {

    async run() {
        const { db, srv, app } = env4('production').folders
        const language = exists('pom.xml') ? 'java' : 'nodejs'

        if (language === 'nodejs') {
            await Promise.all([
                copy(join(__dirname, 'files/db')).to(db),
                copy(join(__dirname, 'files/srv')).to(srv)
            ])
            await copy(join(__dirname, 'files', language)).to(srv)
            await copy(join(__dirname, 'files', 'app')).to(app)
            const { appName, appPath, appUIPaths } = readProject()

            // manifest.json must be unique // REVISIT: Check if relevant for `cds add sample` in Java scenario
            await Promise.all(appUIPaths.map(async p => {
                const manifest = await read(join(appPath, p, 'webapp/manifest.json'))
                manifest['sap.app'].id = appName + '.' + p
                await write(join(appPath, p, 'webapp/manifest.json'), manifest, { spaces: 2 })
            }))
        } else if (language === 'java') {
            await mvn.add('sample')
        }
    }
}
